---
- name: install system packages
  apt:
    update_cache: yes
    pkg:
      - gdal-bin

# user home directory
- name: make project dir
  file: path=/home/openstates state=directory
- name: add project user
  user: name=openstates home=/home/openstates shell=/bin/bash state=present
- name: chown user directory
  file: path=/home/openstates owner=openstates
- name: add env_vars for project user
  template: src=env_vars.j2 dest=/home/openstates/env_vars mode=640
  become_user: "openstates"


# letsencrypt & cronjobs
- name: add update_materialized_views cron
  cron: job=". /home/openstates/env_vars && /home/openstates/virt/bin/python /home/openstates/src/openstates.org/manage.py update_materialized_views" special_time="hourly" name="update materialized views"
- name: add process_subscriptions cron
  cron: job=". /home/openstates/env_vars && /home/openstates/virt/bin/python /home/openstates/src/openstates.org/manage.py process_subscriptions >> /tmp/subscriptions.log" hour="12" minute="30" name="process subscriptions"
- name: add aggregate usage cron
  cron: job=". /home/openstates/env_vars && /home/openstates/virt/bin/python /home/openstates/src/openstates.org/manage.py aggregate_api_usage /var/log/uwsgi/app/openstates.log /var/log/uwsgi/app/openstates.log.1 >> /tmp/aggregation.log" hour="*/2" minute="19" name="aggregate usage"

# new relic
- name: generate new relic config
  command: /home/openstates/virt/bin/newrelic-admin generate-config {{ newrelic_key }} /home/openstates/newrelic.ini creates=/home/openstates/newrelic.ini
- name: rename new relic app
  replace: dest=/home/openstates/newrelic.ini regexp='Python Application' replace='openstates.org'

# django commands
- name: collectstatic
  command: /home/openstates/virt/bin/python manage.py collectstatic --settings=openstates.settings --noinput chdir=/home/openstates/src/openstates.org
  environment: '{{django_environment}}'

# TODO: add run of shapefiles/download.py
# - name: loadshapefiles
#   command: /home/openstates/virt/bin/python manage.py loadshapefiles --settings=openstates.settings chdir=/home/openstates/src/openstates.org
#   environment: '{{django_environment}}'
# - name: loadmappings
#   command: /home/openstates/virt/bin/python manage.py loadmappings --settings=openstates.settings chdir=/home/openstates/src/openstates.org
#   environment: '{{django_environment}}'
